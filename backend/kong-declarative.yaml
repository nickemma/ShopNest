# kong-declarative.yml
_format_version: "3.0"

services:
  # User Service Configuration
  - name: user-service
    url: http://user-service:8080
    routes:
      - name: user-routes
        paths: ["/users", "/auth"]
        methods: ["GET", "POST", "PUT", "DELETE"]
        strip_path: true  
        
    plugins:
      - name: rate-limiting
        config:
          minute: 60  # 60 requests/minute for user endpoints
          policy: redis
          redis_host: redis
          redis_port: 6379
      - name: jwt
        config:
          secret_is_base64: false
          key_claim_name: iss
          claims_to_verify: ["exp"]

  # Product Service Configuration  
  - name: product-service
    url: http://product-service:8080 
    routes:
      - name: public-products
        paths: ["/products", "/api/products"] 
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
      - name: admin-products
        paths: ["/admin/products"]
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
        strip_path: true  
    plugins:
      - name: rate-limiting
        config:
          minute: 120  # Higher limit for product browsing
          policy: redis
          redis_host: redis
          redis_port: 6379
      - name: jwt
        config:
          allow: ["admin"]
          secret_is_base64: false
          key_claim_name: iss
          claims_to_verify: ["exp"]

# Global JWT Consumers
consumers:
  - username: web-app
    jwt_secrets:
      - key: "your-secret-key"  # Must match JWT_SECRET in user-service
        algorithm: HS256
  - username: mobile-app
    jwt_secrets:
      - key: "your-secret-key"
        algorithm: HS256

# Global Plugins (applied to all services)
plugins:
  - name: cors
    config:
      origins: ["*"]
      methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
      headers: ["Authorization", "Content-Type"]
      exposed_headers: ["X-RateLimit-Limit", "X-RateLimit-Remaining"]
      max_age: 3600